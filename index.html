<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyCast Pro - Interactive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            overflow-x: hidden;
            color: white;
            background: #0f172a; /* Fallback */
            -webkit-tap-highlight-color: transparent;
        }

        /* Canvas for Weather Particles */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Background Gradients */
        .bg-gradient-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            transition: opacity 1.5s ease;
        }
        .bg-sunny { background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); }
        .bg-night { background: linear-gradient(180deg, #09203f 0%, #537895 100%); }
        .bg-cloudy { background: linear-gradient(180deg, #8e9eab 0%, #eef2f3 100%); }
        .bg-rainy { background: linear-gradient(180deg, #203A43 0%, #2C5364 100%); }

        /* 3D Tilt Card Styling */
        .tilt-card {
            transform-style: preserve-3d;
            transform: perspective(1000px);
            transition: transform 0.1s ease;
        }
        .tilt-inner {
            transform: translateZ(20px);
        }

        /* Glassmorphism */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Interactive Hover Glow */
        .glass-card::before {
            content: "";
            position: absolute;
            top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: skewX(-25deg);
            transition: 0.5s;
        }
        .glass-card:hover::before { left: 100%; transition: 0.7s; }
        .glass-card:hover { background: rgba(255, 255, 255, 0.15); box-shadow: 0 10px 40px rgba(0,0,0,0.2); }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .animate-enter { animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        .delay-4 { animation-delay: 0.4s; }

        /* Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 250px; width: 100%; border-radius: 1rem; z-index: 10; cursor: crosshair; filter: grayscale(30%) contrast(1.1); transition: filter 0.3s; }
        #map:hover { filter: grayscale(0%); }

        /* Search Overlay */
        #search-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); }
    </style>
</head>
<body>

    <div id="bg-gradient" class="bg-gradient-layer bg-sunny"></div>
    <canvas id="bg-canvas"></canvas>

    <div id="search-overlay" class="fixed inset-0 z-50 hidden flex-col p-6 animate-fade">
        <div class="w-full max-w-lg mx-auto">
            <div class="flex items-center gap-4 mb-8">
                <button onclick="closeSearch()" class="p-2 rounded-full hover:bg-white/10 transition"><i data-lucide="arrow-left" class="w-6 h-6 text-white"></i></button>
                <div class="flex-1 relative group">
                    <input type="text" id="search-input" placeholder="Search city..." 
                        class="w-full bg-white/10 border border-white/10 rounded-2xl px-12 py-4 text-lg text-white placeholder-white/40 focus:outline-none focus:bg-white/20 transition ring-0 focus:ring-2 focus:ring-white/20">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/40 group-focus-within:text-white transition"></i>
                </div>
            </div>
            <div id="search-results" class="space-y-2"></div>
        </div>
    </div>

    <main class="w-full max-w-md min-h-screen p-4 pb-10 relative z-10">
        
        <header class="flex justify-between items-start mb-8 pt-4">
            <div class="cursor-pointer group" onclick="openSearch()">
                <div class="flex items-center gap-2 mb-1 group-hover:translate-x-1 transition">
                    <h1 id="city" class="text-3xl font-bold tracking-tight drop-shadow-lg">Locating...</h1>
                    <i data-lucide="chevron-down" class="w-5 h-5 opacity-80"></i>
                </div>
                <p id="date" class="text-sm font-medium opacity-80 uppercase tracking-wide"></p>
            </div>
            <div class="flex gap-3">
                <button id="notif-btn" onclick="requestNativeNotification()" class="p-3 bg-white/10 rounded-full hover:bg-white/20 hover:scale-110 active:scale-95 transition backdrop-blur-md border border-white/10 shadow-lg">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                </button>
                <button onclick="getLocation()" class="p-3 bg-white/10 rounded-full hover:bg-white/20 hover:scale-110 active:scale-95 transition backdrop-blur-md border border-white/10 shadow-lg">
                    <i data-lucide="map-pin" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center z-40">
            <div class="w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-4"></div>
            <p class="animate-pulse text-sm font-bold tracking-widest uppercase">Forecasting</p>
        </div>

        <div id="content" class="hidden space-y-6 perspective-container">
            
            <section class="text-center py-6 animate-enter">
                <div id="weather-icon-container" class="inline-block mb-2 filter drop-shadow-2xl hover:scale-110 transition duration-500 cursor-pointer">
                    </div>
                <h2 class="text-[6.5rem] font-bold leading-none tracking-tighter drop-shadow-xl mix-blend-overlay text-white relative">
                    <span id="temp" class="counter">0</span>°
                </h2>
                <div class="flex items-center justify-center gap-3 mt-4">
                    <p id="description" class="text-xl font-medium capitalize bg-white/10 px-4 py-1 rounded-full backdrop-blur-sm shadow-sm border border-white/5"></p>
                    <p class="text-lg font-medium opacity-90">H:<span id="high">--</span>° L:<span id="low">--</span>°</p>
                </div>
            </section>

            <section class="glass-panel rounded-3xl p-5 animate-enter delay-1 tilt-card" data-tilt>
                <div class="flex items-center gap-2 mb-4 opacity-70">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Hourly Forecast</span>
                </div>
                <div id="hourly-list" class="flex gap-4 overflow-x-auto no-scrollbar pb-2 cursor-grab active:cursor-grabbing"></div>
            </section>

            <section class="grid grid-cols-2 gap-3 animate-enter delay-2">
                <div class="glass-card tilt-card" data-tilt>
                    <div class="flex items-center gap-2 opacity-70 mb-2">
                        <i data-lucide="sun" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">UV Index</span>
                    </div>
                    <div class="tilt-inner">
                        <span id="uv-val" class="text-2xl font-bold block counter">0</span>
                        <span id="uv-text" class="text-sm font-medium">Low</span>
                    </div>
                    <div class="w-full h-1 bg-white/20 rounded-full mt-3 overflow-hidden">
                        <div id="uv-bar" class="h-full bg-gradient-to-r from-green-400 to-red-500 rounded-full w-0 transition-all duration-1000 ease-out"></div>
                    </div>
                </div>

                <div class="glass-card tilt-card" data-tilt>
                    <div class="flex items-center gap-2 opacity-70 mb-2">
                        <i data-lucide="wind" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">Wind</span>
                    </div>
                    <div class="mt-auto tilt-inner">
                        <div class="flex items-baseline gap-1">
                            <span id="wind" class="text-2xl font-bold counter">0</span>
                            <span class="text-sm">km/h</span>
                        </div>
                        <div class="text-xs opacity-70 mt-1 border-t border-white/10 pt-2 flex items-center gap-1">
                            <i data-lucide="compass" class="w-3 h-3"></i> <span id="wind-dir">--</span>
                        </div>
                    </div>
                </div>

                <div class="glass-card tilt-card" data-tilt>
                    <div class="flex items-center gap-2 opacity-70 mb-2">
                        <i data-lucide="thermometer" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">Feels Like</span>
                    </div>
                    <div class="mt-auto tilt-inner">
                        <span id="feels-like" class="text-2xl font-bold counter">0</span><span class="text-2xl font-bold">°</span>
                    </div>
                    <div class="text-xs opacity-70 mt-1" id="feels-desc">Similar</div>
                </div>

                <div class="glass-card tilt-card" data-tilt>
                    <div class="flex items-center gap-2 opacity-70 mb-2">
                        <i data-lucide="droplets" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">Humidity</span>
                    </div>
                    <div class="mt-auto tilt-inner">
                        <span id="humidity" class="text-2xl font-bold counter">0</span><span class="text-2xl font-bold">%</span>
                    </div>
                    <div class="text-xs opacity-70 mt-1" id="dew-point">Dew Point: --°</div>
                </div>

                <div class="glass-card tilt-card" data-tilt>
                    <div class="flex items-center gap-2 opacity-70 mb-2">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">Visibility</span>
                    </div>
                    <div class="mt-auto tilt-inner">
                        <span id="visibility" class="text-2xl font-bold counter">0</span>
                        <span class="text-sm">km</span>
                    </div>
                    <div class="text-xs opacity-70 mt-1">Clear view</div>
                </div>

                <div class="glass-card tilt-card" data-tilt>
                    <div class="flex items-center gap-2 opacity-70 mb-2">
                        <i data-lucide="sunset" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">Sunset</span>
                    </div>
                    <div class="mt-auto tilt-inner">
                        <span id="sunset" class="text-2xl font-bold">--:--</span>
                    </div>
                    <div class="text-xs opacity-70 mt-1">Sunrise: <span id="sunrise">--:--</span></div>
                </div>
            </section>

            <section class="glass-panel rounded-3xl p-5 animate-enter delay-3 tilt-card" data-tilt>
                <div class="flex items-center gap-2 mb-4 opacity-70">
                    <i data-lucide="calendar-days" class="w-4 h-4"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">7-Day Forecast</span>
                </div>
                <div id="daily-list" class="space-y-1"></div>
            </section>

            <section class="animate-enter delay-4 pb-4">
                <div class="glass-panel p-2 rounded-2xl tilt-card" data-tilt style="transform-style: flat;"> <div id="map"></div>
                </div>
                <p class="text-center text-xs opacity-50 mt-3">Tap map to pin location</p>
            </section>
        </div>
    </main>

    <script>
        // --- 1. Creative Particles System (Canvas) ---
        class WeatherFX {
            constructor() {
                this.canvas = document.getElementById('bg-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.type = 'clear'; // clear, rain, snow, clouds
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.animate();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            setType(code) {
                // Determine effect based on WMO code
                if ([51, 53, 55, 61, 63, 65, 80, 81, 82, 95].includes(code)) this.type = 'rain';
                else if ([71, 73, 75, 77, 85, 86].includes(code)) this.type = 'snow';
                else if ([0, 1].includes(code)) this.type = 'sun';
                else this.type = 'cloud';
                
                this.particles = [];
                this.initParticles();
            }

            initParticles() {
                const count = this.type === 'rain' ? 100 : this.type === 'snow' ? 50 : 30;
                for(let i=0; i<count; i++) {
                    this.particles.push(this.createParticle());
                }
            }

            createParticle() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    size: Math.random() * (this.type === 'sun' ? 4 : 2) + 1,
                    speedY: Math.random() * (this.type === 'rain' ? 15 : this.type === 'snow' ? 2 : 0.5) + 0.5,
                    speedX: this.type === 'snow' ? Math.random() * 2 - 1 : this.type === 'sun' ? Math.random() * 0.5 - 0.25 : 0,
                    opacity: Math.random() * 0.5 + 0.1
                };
            }

            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.particles.forEach(p => {
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                    this.ctx.beginPath();
                    
                    if (this.type === 'rain') {
                        this.ctx.rect(p.x, p.y, 1, p.size * 5);
                    } else {
                        this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    }
                    this.ctx.fill();

                    // Movement
                    p.y += p.speedY;
                    p.x += p.speedX;

                    if (p.y > this.canvas.height) p.y = -10;
                    if (p.x > this.canvas.width) p.x = 0;
                    if (p.x < 0) p.x = this.canvas.width;
                });

                requestAnimationFrame(() => this.animate());
            }
        }
        const fx = new WeatherFX();

        // --- 2. 3D Tilt Interaction ---
        function initTilt() {
            // Only add tilt on non-touch devices for performance/UX
            if (window.matchMedia("(hover: hover)").matches) {
                document.querySelectorAll('.tilt-card').forEach(card => {
                    card.addEventListener('mousemove', (e) => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;
                        
                        const rotateX = ((y - centerY) / centerY) * -10; // Max 10deg rotation
                        const rotateY = ((x - centerX) / centerX) * 10;

                        card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = `perspective(1000px) rotateX(0) rotateY(0) scale(1)`;
                    });
                });
            }
        }

        // --- 3. Number Counter Animation ---
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- Core Application ---
        const weatherCodeMap = {
            0: { desc: "Clear Sky", icon: "sun", bg: "bg-sunny" },
            1: { desc: "Mainly Clear", icon: "cloud-sun", bg: "bg-sunny" },
            2: { desc: "Partly Cloudy", icon: "cloud-sun", bg: "bg-cloudy" },
            3: { desc: "Overcast", icon: "cloud", bg: "bg-cloudy" },
            45: { desc: "Fog", icon: "cloud-fog", bg: "bg-cloudy" },
            51: { desc: "Drizzle", icon: "cloud-drizzle", bg: "bg-rainy" },
            61: { desc: "Rain", icon: "cloud-rain", bg: "bg-rainy" },
            71: { desc: "Snow", icon: "snowflake", bg: "bg-rainy" },
            95: { desc: "Thunderstorm", icon: "cloud-lightning", bg: "bg-rainy" }
        };

        const getWCode = (code, isDay = 1) => {
            let data = weatherCodeMap[code] || { desc: "Unknown", icon: "cloud", bg: "bg-cloudy" };
            // Fallback for codes not explicitly listed
            if(code >= 45 && code <= 48) data = weatherCodeMap[45];
            if(code >= 51 && code <= 67) data = weatherCodeMap[61];
            if(code >= 71 && code <= 77) data = weatherCodeMap[71];
            if(code >= 80 && code <= 82) data = weatherCodeMap[61];

            if (isDay === 0 && data.icon === 'sun') data.icon = 'moon';
            if (isDay === 0 && data.icon === 'cloud-sun') data.icon = 'cloud-moon';
            if (isDay === 0) data.bg = 'bg-night';
            return data;
        };

        let map, marker;

        async function fetchWeather(lat, lon) {
            document.getElementById('loader').classList.remove('hidden');
            // document.getElementById('content').classList.add('hidden'); // Keep content visible for smoother feel
            
            try {
                // Reverse Geo
                const geoReq = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                const geo = await geoReq.json();
                document.getElementById('city').innerText = geo.address.city || geo.address.town || geo.address.county || "Location";

                // Weather API
                const params = new URLSearchParams({
                    latitude: lat,
                    longitude: lon,
                    current: "temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,wind_direction_10m,surface_pressure,visibility",
                    hourly: "temperature_2m,weather_code,precipitation_probability",
                    daily: "weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max,precipitation_probability_max",
                    timezone: "auto"
                });

                const res = await fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`);
                const data = await res.json();
                
                renderApp(data, lat, lon);

            } catch (err) {
                console.error(err);
                alert("Weather data unavailable.");
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function renderApp(data, lat, lon) {
            const cur = data.current;
            const wInfo = getWCode(cur.weather_code, cur.is_day);

            // 1. Update Background & Particles
            const bgLayer = document.getElementById('bg-gradient');
            bgLayer.className = `bg-gradient-layer ${wInfo.bg}`;
            fx.setType(cur.weather_code);

            // 2. Main Texts
            document.getElementById('date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('description').innerText = wInfo.desc;
            document.getElementById('high').innerText = Math.round(data.daily.temperature_2m_max[0]);
            document.getElementById('low').innerText = Math.round(data.daily.temperature_2m_min[0]);
            
            // Icon
            document.getElementById('weather-icon-container').innerHTML = `<i data-lucide="${wInfo.icon}" class="w-24 h-24 text-white"></i>`;

            // 3. Animate Numbers
            animateValue(document.getElementById('temp'), 0, Math.round(cur.temperature_2m), 1500);
            animateValue(document.getElementById('wind'), 0, Math.round(cur.wind_speed_10m), 1500);
            animateValue(document.getElementById('humidity'), 0, cur.relative_humidity_2m, 1500);
            animateValue(document.getElementById('feels-like'), 0, Math.round(cur.apparent_temperature), 1500);
            animateValue(document.getElementById('uv-val'), 0, Math.round(data.daily.uv_index_max[0]), 1500);
            animateValue(document.getElementById('visibility'), 0, (cur.visibility/1000).toFixed(1), 1500);

            // 4. Details
            document.getElementById('wind-dir').innerText = `${cur.wind_direction_10m}°`;
            document.getElementById('dew-point').innerText = `Pressure: ${cur.surface_pressure}hPa`;
            document.getElementById('feels-desc').innerText = Math.abs(cur.apparent_temperature - cur.temperature_2m) < 2 ? "Similar to actual" : "Differs from actual";
            
            const uvMax = data.daily.uv_index_max[0];
            document.getElementById('uv-text').innerText = uvMax <= 2 ? "Low" : uvMax <= 5 ? "Moderate" : uvMax <= 7 ? "High" : "Extreme";
            setTimeout(() => { document.getElementById('uv-bar').style.width = `${Math.min((uvMax / 11) * 100, 100)}%`; }, 200);

            const formatTime = (iso) => new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('sunrise').innerText = formatTime(data.daily.sunrise[0]);
            document.getElementById('sunset').innerText = formatTime(data.daily.sunset[0]);

            // 5. Lists
            const currentHour = new Date().getHours();
            document.getElementById('hourly-list').innerHTML = data.hourly.time.slice(0, 24).map((t, i) => {
                const h = new Date(t).getHours();
                if(i < currentHour && new Date(t).getDate() === new Date().getDate()) return '';
                const hCode = data.hourly.weather_code[i];
                const hIcon = getWCode(hCode, (h>=6 && h<=20)?1:0).icon;
                return `
                <div class="flex flex-col items-center justify-between min-w-[70px] p-3 rounded-2xl ${i===0?'bg-white/20 shadow-inner':'hover:bg-white/10'} transition group">
                    <span class="text-xs font-medium opacity-80">${i===0?'Now':h+':00'}</span>
                    <i data-lucide="${hIcon}" class="w-6 h-6 my-2 group-hover:scale-110 transition"></i>
                    <span class="text-lg font-bold">${Math.round(data.hourly.temperature_2m[i])}°</span>
                    <div class="flex items-center gap-1 text-[10px] text-blue-200 mt-1 opacity-80">
                         <i data-lucide="droplets" class="w-3 h-3"></i> ${data.hourly.precipitation_probability[i]}%
                    </div>
                </div>`;
            }).join('');

            document.getElementById('daily-list').innerHTML = data.daily.time.slice(1, 8).map((t, i) => {
                const date = new Date(t);
                const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                const icon = getWCode(data.daily.weather_code[i+1], 1).icon;
                const min = Math.round(data.daily.temperature_2m_min[i+1]);
                const max = Math.round(data.daily.temperature_2m_max[i+1]);
                return `
                <div class="flex items-center justify-between py-3 border-b border-white/10 last:border-0 hover:bg-white/5 px-2 rounded-lg transition">
                    <span class="w-12 font-medium">${day}</span>
                    <i data-lucide="${icon}" class="w-5 h-5 opacity-90"></i>
                    <div class="flex items-center flex-1 gap-2 mx-4">
                        <span class="text-xs opacity-60 w-6 text-right">${min}°</span>
                        <div class="h-1 bg-white/10 rounded-full flex-1 relative overflow-hidden">
                             <div class="absolute h-full bg-gradient-to-r from-blue-300 to-yellow-300 opacity-80" style="left: 10%; right: 10%"></div>
                        </div>
                        <span class="text-xs font-bold w-6 text-left">${max}°</span>
                    </div>
                </div>`;
            }).join('');

            initMap(lat, lon);
            lucide.createIcons();
            initTilt(); // Re-init tilt for new elements
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        function initMap(lat, lon) {
            if (!map) {
                map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
                marker = L.marker([lat, lon]).addTo(map);
                map.on('click', e => { 
                    marker.setLatLng(e.latlng); map.panTo(e.latlng); fetchWeather(e.latlng.lat, e.latlng.lng); 
                });
            } else {
                map.setView([lat, lon], 10);
                marker.setLatLng([lat, lon]);
            }
            setTimeout(() => map.invalidateSize(), 300);
        }

        // --- Interaction Handlers ---
        function getLocation() {
            navigator.geolocation.getCurrentPosition(
                p => fetchWeather(p.coords.latitude, p.coords.longitude),
                () => fetchWeather(40.7128, -74.0060)
            );
        }

        function openSearch() { document.getElementById('search-overlay').classList.replace('hidden', 'flex'); document.getElementById('search-input').focus(); }
        function closeSearch() { document.getElementById('search-overlay').classList.replace('flex', 'hidden'); }

        let dbTimer;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(dbTimer);
            const q = e.target.value.trim();
            if (q.length < 3) return;
            dbTimer = setTimeout(async () => {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=5`);
                const data = await res.json();
                document.getElementById('search-results').innerHTML = data.map(i => `
                    <div onclick="closeSearch(); fetchWeather(${i.lat}, ${i.lon})" 
                        class="p-4 bg-white/5 hover:bg-white/10 rounded-xl cursor-pointer transition border border-white/5 animate-fade">
                        <span class="font-bold text-white block">${i.display_name.split(',')[0]}</span>
                        <span class="text-xs text-white/50 truncate block">${i.display_name}</span>
                    </div>`).join('');
            }, 300);
        });

        async function requestNativeNotification() {
            if(await Notification.requestPermission() === "granted") {
                new Notification("Notifications Active", { body: "You will receive weather alerts.", icon: "https://cdn-icons-png.flaticon.com/512/1163/1163763.png" });
            }
        }

        window.onload = getLocation;
    </script>
</body>
</html>
